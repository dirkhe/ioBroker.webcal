{
  "version": 3,
  "sources": ["../../src/lib/IcalCalendarEvent.ts"],
  "sourcesContent": ["// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore\nimport ICAL from \"ical.js\";\nimport { CalendarEvent, ICalendarTimeRangObj } from \"./calendarManager\";\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore\nimport { AdapterInstance } from \"@iobroker/adapter-core\";\nlet adapter: AdapterInstance;\n\nexport function initLib(adapterInstance: AdapterInstance, localTimeZone: string): void {\n\tadapter = adapterInstance;\n\tICAL.Timezone.localTimezone = new ICAL.Timezone({ tzID: localTimeZone });\n}\n\nexport function getAllIcalCalendarEvents(\n\tcalendarEventData: string,\n\tcalendarName: string,\n\tstartDate: Date,\n\tendDate: Date,\n\tcheckDateRange?: boolean,\n): webcal.ICalendarEventBase[] {\n\tconst result: webcal.ICalendarEventBase[] = [];\n\ttry {\n\t\tadapter.log.debug(\"parse calendar data:\\n\" + calendarEventData.replace(/\\s*([:;=])\\s*/gm, \"$1\"));\n\t\tconst jcalData = ICAL.parse(calendarEventData);\n\t\tconst comp = new ICAL.Component(jcalData);\n\t\tconst calTimezoneComp = comp.getFirstSubcomponent(\"vtimezone\");\n\t\tconst calTimezone = calTimezoneComp ? new ICAL.Timezone(calTimezoneComp) : null;\n\t\tconst allEvents = comp.getAllSubcomponents(\"vevent\");\n\n\t\tfor (const i in allEvents) {\n\t\t\tconst ev: IcalCalendarEvent = new IcalCalendarEvent(\n\t\t\t\tallEvents[i],\n\t\t\t\tcalTimezone,\n\t\t\t\tcalendarName,\n\t\t\t\tstartDate,\n\t\t\t\tendDate,\n\t\t\t);\n\t\t\tif (ev) {\n\t\t\t\tif (checkDateRange) {\n\t\t\t\t\tconst timeObj = ev.getNextTimeObj(true);\n\t\t\t\t\tif (!timeObj || timeObj.startDate < startDate || timeObj.endDate > endDate) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tresult.push(ev);\n\t\t\t}\n\t\t}\n\t} catch (error) {\n\t\tadapter.log.error(\"could not read calendar Event: \" + error);\n\t}\n\treturn result;\n}\n\nexport class IcalCalendarEvent extends CalendarEvent {\n\ticalEvent?: ICAL.Event;\n\ttimezone?: ICAL.Timezone;\n\trecurIterator?: ICAL.RecurExpansion;\n\n\tstatic fromData(\n\t\tcalendarEventData: string,\n\t\tcalendarName: string,\n\t\tstartDate: Date,\n\t\tendDate: Date,\n\t): IcalCalendarEvent | null {\n\t\ttry {\n\t\t\tadapter.log.debug(\"parse calendar data:\\n\" + calendarEventData.replace(/\\s*([:;=])\\s*/gm, \"$1\"));\n\t\t\tconst jcalData = ICAL.parse(calendarEventData);\n\t\t\tconst comp = new ICAL.Component(jcalData);\n\t\t\tconst calTimezone = comp.getFirstSubcomponent(\"vtimezone\");\n\n\t\t\treturn new IcalCalendarEvent(\n\t\t\t\tcomp.getFirstSubcomponent(\"vevent\"),\n\t\t\t\tcalTimezone ? new ICAL.Timezone(calTimezone) : null,\n\t\t\t\tcalendarName,\n\t\t\t\tstartDate,\n\t\t\t\tendDate,\n\t\t\t);\n\t\t} catch (error) {\n\t\t\tadapter.log.error(\"could not read calendar Event: \" + error);\n\t\t\tadapter.log.debug(calendarEventData);\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tconstructor(\n\t\teventComp: ICAL.Component,\n\t\tcalTimezone: ICAL.Timezone,\n\t\tcalendarName: string,\n\t\tstartDate: Date,\n\t\tendDate: Date,\n\t) {\n\t\tsuper(endDate, calendarName);\n\t\tthis.timezone = calTimezone;\n\t\ttry {\n\t\t\tthis.icalEvent = new ICAL.Event(eventComp);\n\t\t\tthis.summary = this.icalEvent.summary || \"\";\n\t\t\tthis.description = this.icalEvent.description || \"\";\n\n\t\t\tif (this.icalEvent.isRecurring()) {\n\t\t\t\tif (![\"HOURLY\", \"SECONDLY\", \"MINUTELY\"].includes(this.icalEvent.getRecurrenceTypes())) {\n\t\t\t\t\tconst timeObj = this.getNextTimeObj(true);\n\t\t\t\t\tif (timeObj) {\n\t\t\t\t\t\tconst startTime = ICAL.Time.fromData(\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tyear: startDate.getFullYear(),\n\t\t\t\t\t\t\t\tmonth: startDate.getMonth() + 1,\n\t\t\t\t\t\t\t\tday: startDate.getDate(),\n\t\t\t\t\t\t\t\thour: timeObj.startDate.getHours(),\n\t\t\t\t\t\t\t\tminute: timeObj.startDate.getMinutes(),\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tthis.timezone,\n\t\t\t\t\t\t);\n\t\t\t\t\t\tthis.recurIterator = this.icalEvent.iterator(startTime);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tadapter.log.error(\"could not read calendar Event: \" + error);\n\t\t\tthis.icalEvent = null;\n\t\t}\n\t}\n\n\tgetNextTimeObj(isFirstCall: boolean): ICalendarTimeRangObj | null {\n\t\tlet start: ICAL.Time;\n\t\tlet end: ICAL.Time;\n\t\tif (this.recurIterator) {\n\t\t\tstart = this.recurIterator.next();\n\t\t\tif (start) {\n\t\t\t\tif (this.timezone) {\n\t\t\t\t\tstart = start.convertToZone(this.timezone);\n\t\t\t\t}\n\t\t\t\tif (start.toUnixTime() > this.maxUnixTime) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\ttry {\n\t\t\t\t\tend = this.icalEvent.getOccurrenceDetails(start).endDate;\n\t\t\t\t} catch (error) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t} else if (isFirstCall) {\n\t\t\tstart = this.icalEvent.startDate;\n\t\t\tif (this.timezone) {\n\t\t\t\tstart = start.convertToZone(this.timezone);\n\t\t\t}\n\t\t\tend = this.icalEvent.endDate;\n\t\t} else {\n\t\t\treturn null;\n\t\t}\n\t\tif (this.timezone) {\n\t\t\tend = end.convertToZone(this.timezone);\n\t\t}\n\t\treturn {\n\t\t\tstartDate: start.toJSDate(), //.local();\n\t\t\tendDate: end.toJSDate(), //.local();\n\t\t};\n\t}\n\n\tstatic createIcalEventString(data: webcal.ICalendarEventData): string {\n\t\tconst cal = new ICAL.Component([\"vcalendar\", [], []]);\n\t\tcal.updatePropertyWithValue(\"prodid\", \"-//ioBroker.webCal\");\n\t\tconst vevent = new ICAL.Component(\"vevent\");\n\t\tconst event = new ICAL.Event(vevent);\n\n\t\tevent.summary = data.summary;\n\t\tevent.description = \"ioBroker webCal\";\n\t\tevent.uid = new Date().getTime().toString();\n\t\tevent.startDate =\n\t\t\ttypeof data.startDate == \"string\"\n\t\t\t\t? ICAL.Time.fromString(data.startDate)\n\t\t\t\t: ICAL.Time.fromData(data.startDate);\n\t\tif (data.endDate) {\n\t\t\tevent.endDate =\n\t\t\t\ttypeof data.endDate == \"string\" ? ICAL.Time.fromString(data.endDate) : ICAL.Time.fromData(data.endDate);\n\t\t}\n\t\tcal.addSubcomponent(vevent);\n\t\treturn cal.toString();\n\t}\n}\n"],
  "mappings": "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",
  "names": ["ICAL"]
}
